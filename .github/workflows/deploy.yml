name: Deploy RPM

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build RPM in Fedora Container
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}

          # Validate version format: only digits and dots (e.g., "1.2.3")
          if ! [[ "$VERSION" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
            echo "Error: Invalid version '$VERSION'. Expected format like '1.2.3' from tag 'v1.2.3'."
            exit 1
          fi
          echo "Building version: $VERSION"

          # Run build in Fedora container
          docker run --rm -v "$PWD:/src" -w /src -e VERSION=$VERSION fedora:latest /src/packaging/build-rpm.sh

          # Fix ownership of generated RPMs on the host
          sudo chown $(id -u):$(id -g) ./*.rpm
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wthr-rpm
          path: ./*.rpm

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: wthr-rpm
          path: .

      - name: Deploy to EC2
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: deploy.wthr.lol
          USER: deploy
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          trap 'rm -f ~/.ssh/id_rsa' EXIT
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          # Find the RPM file
          RPM_FILE=$(ls *.rpm)
          echo "Deploying $RPM_FILE..."

          # Copy RPM
          scp $RPM_FILE $USER@$HOST:/tmp/$RPM_FILE

          # Install/Update - RPM triggers restart automatically via %postun_with_restart
          ssh $USER@$HOST "sudo dnf install -vy /tmp/$RPM_FILE"
