name: Deploy RPM

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build RPM in Fedora Container
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Building version: $VERSION"

          # Run build in Fedora container to access correct RPM macros/deps
          docker run --rm -v $PWD:/src -w /src -e VERSION=$VERSION fedora:latest /bin/bash -c "
            set -ex
            # Install build dependencies
            dnf install -y rpm-build golang systemd-rpm-macros tar git

            # Setup Build Environment
            mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

            # Create Source Tarball
            # We transform the paths so they extract into a wthr-VERSION directory matches %setup expectations
            tar --exclude-vcs -czf ~/rpmbuild/SOURCES/wthr-\$VERSION.tar.gz --transform \"s,^,wthr-\$VERSION/,\" .

            # Build RPM
            rpmbuild -bb packaging/rpm/wthr.spec \
              --define \"_version \$VERSION\" \
              --define \"_topdir \$HOME/rpmbuild\"

            # Output
            cp ~/rpmbuild/RPMS/*/*.rpm /src/
            chown $(id -u):$(id -g) /src/*.rpm
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wthr-rpm
          path: ./*.rpm

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: wthr-rpm
          path: .

      - name: Deploy to EC2
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: deploy.wthr.lol
          USER: deploy
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          # Find the RPM file
          RPM_FILE=$(ls *.rpm)
          echo "Deploying $RPM_FILE..."

          # Copy RPM
          scp $RPM_FILE $USER@$HOST:/tmp/$RPM_FILE

          # Install/Update - RPM triggers restart automatically via %postun_with_restart
          ssh $USER@$HOST "sudo dnf install -y /tmp/$RPM_FILE"
