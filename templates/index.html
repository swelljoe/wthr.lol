<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wthr.lol - Weather Without the BS</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <main class="weather-container">
        <div class="hero">
            <h1>üå§Ô∏è wthr.lol</h1>
            <p>Weather without the ads, tracking, or BS</p>
        </div>

        <article class="weather-card">
            <header>
                <h2>Current Weather</h2>
            </header>

            <div class="location-input">
                <div class="search-container">
                    <input type="text" id="location" placeholder="Enter city or zip..."
                        onkeypress="if(event.key === 'Enter') manualLocate()" autocomplete="off">
                    <ul id="suggestions" class="suggestions"></ul>
                </div>
                <button type="button" onclick="manualLocate()">Search</button>
                <button type="button" id="locate-btn" class="secondary" onclick="locateMe()">üìç Locate Me</button>
            </div>

            <div id="weather-display">
                <p style="text-align: center; color: var(--text-secondary);">
                    Enter a location or click "Locate Me" to get started.
                </p>
            </div>
        </article>

        <div style="margin-top: 3rem; opacity: 0.7;">
            <article>
                <h3>About wthr.lol</h3>
                <p>
                    A simple, ad-free weather application built with Go + SQLite.
                    Data provided by <a href="https://www.weather.gov/documentation/services-web-api"
                        style="color: var(--accent-color)">NWS API</a>.
                </p>
            </article>
        </div>
    </main>

    <script>
        // Check if we already have permission or should try automatically
        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();

            if (navigator.geolocation) {
                // Try to get location silently first (only works if permission granted)
                navigator.permissions.query({ name: 'geolocation' }).then(result => {
                    if (result.state === 'granted') {
                        locateMe(true);
                    } else if (result.state === 'prompt') {
                        locateMe(true);
                    }
                });
            }
        });

        function setupAutocomplete() {
            const input = document.getElementById('location');
            const list = document.getElementById('suggestions');
            let debounceTimer;

            // Hide on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.remove('visible');
                }
            });

            input.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    list.classList.remove('visible');
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`/api/search?q=${encodeURIComponent(query)}`)
                        .then(r => r.json())
                        .then(places => {
                            list.innerHTML = '';
                            if (places && places.length > 0) {
                                places.forEach(p => {
                                    const li = document.createElement('li');
                                    const nameSpan = document.createElement('span');
                                    nameSpan.className = 'place-name';
                                    nameSpan.textContent = p.name;
                                    const metaSpan = document.createElement('span');
                                    metaSpan.className = 'place-meta';
                                    metaSpan.textContent = `${p.state} ${p.zip || ''}`;
                                    li.appendChild(nameSpan);
                                    li.appendChild(metaSpan);
                                    li.onclick = () => {
                                        input.value = `${p.name}, ${p.state}`;
                                        list.classList.remove('visible');
                                        fetchWeather(`lat=${p.latitude}&lon=${p.longitude}`);
                                    };
                                    list.appendChild(li);
                                });
                                list.classList.add('visible');
                            } else {
                                list.classList.remove('visible');
                            }
                        })
                        .catch(err => console.error(err));
                }, 300);
            });
        }

        function locateMe(silent = false) {
            if (!navigator.geolocation) {
                if (!silent) alert("Geolocation is not supported by your browser");
                return;
            }

            const btn = document.getElementById('locate-btn');
            const origText = btn.innerText;

            if (!silent) {
                btn.innerText = "Locating...";
                btn.disabled = true;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchWeather(`lat=${lat}&lon=${lon}`);
                },
                (error) => {
                    // Reset button text and show error if it was NOT a silent attempt that failed
                    if (!silent) {
                        alert("Unable to retrieve your location");
                        btn.innerText = origText;
                        btn.disabled = false;
                    } else {
                        console.log("Auto-location unavailable or denied");
                    }
                }
            );
        }

        function manualLocate() {
            const input = document.getElementById('location');
            const query = input.value;
            if (!query) return;
            fetchWeather(`location=${encodeURIComponent(query)}`);
        }

        function fetchWeather(qs) {
            const display = document.getElementById('weather-display');
            display.style.opacity = '0.5';

            fetch(`/api/weather?${qs}`)
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(t || r.statusText) });
                    return r.text();
                })
                .then(html => {
                    display.innerHTML = html;
                    display.style.opacity = '1';

                    // Reset 'Locate Me' btn if it was used
                    const btn = document.getElementById('locate-btn');
                    if (btn.disabled) {
                        btn.innerText = "üìç Locate Me";
                        btn.disabled = false;
                    }
                })
                .catch(e => {
                    display.innerHTML = `<div style='text-align:center; padding: 2rem; color: var(--error-color)'>
                        <h3>Error</h3>
                        <p></p>
                    </div>`;
                    const errorParagraph = display.querySelector('p');
                    if (errorParagraph) {
                        errorParagraph.textContent = e.message;
                    }
                    display.style.opacity = '1';

                    const btn = document.getElementById('locate-btn');
                    if (btn.disabled) {
                        btn.innerText = "üìç Locate Me";
                        btn.disabled = false;
                    }
                });
        }
    </script>
</body>

</html>