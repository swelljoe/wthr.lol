<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wthr.lol - Weather Without the BS</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <main class="weather-container">
        <div class="hero">
            <h1>üå§Ô∏è wthr.lol</h1>
            <p>Weather without the ads, tracking, or BS</p>
        </div>

        <article class="weather-card">
            <header>
                <h2>Current Weather</h2>
            </header>

            <div class="location-input">
                <input type="text" id="location" placeholder="Enter city name..."
                    onkeypress="if(event.key === 'Enter') manualLocate()">
                <button type="button" onclick="manualLocate()">Search</button>
                <button type="button" id="locate-btn" class="secondary" onclick="locateMe()">üìç Locate Me</button>
            </div>

            <div id="weather-display">
                <p style="text-align: center; color: var(--text-secondary);">
                    Enter a location or click "Locate Me" to get started.
                </p>
            </div>
        </article>

        <div style="margin-top: 3rem; opacity: 0.7;">
            <article>
                <h3>About wthr.lol</h3>
                <p>
                    A simple, ad-free weather application built with Go + SQLite.
                    Data provided by <a href="https://www.weather.gov/documentation/services-web-api"
                        style="color: var(--accent-color)">NWS API</a>.
                </p>
            </article>
        </div>
    </main>

    <script>
        // Check if we already have permission or should try automatically
        document.addEventListener('DOMContentLoaded', () => {
            if (navigator.geolocation) {
                // Try to get location silently first (only works if permission granted)
                navigator.permissions.query({ name: 'geolocation' }).then(result => {
                    if (result.state === 'granted') {
                        locateMe(true);
                    } else if (result.state === 'prompt') {
                        // Optional: Could prompt, but maybe too intrusive? 
                        // User asked "use location services... ask the user when not".
                        // So we should basically try it.
                        locateMe(true);
                    }
                });
            }
        });

        function locateMe(silent = false) {
            if (!navigator.geolocation) {
                if (!silent) alert("Geolocation is not supported by your browser");
                return;
            }

            const btn = document.getElementById('locate-btn');
            const origText = btn.innerText;

            if (!silent) {
                btn.innerText = "Locating...";
                btn.disabled = true;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchWeather(`lat=${lat}&lon=${lon}`);
                },
                (error) => {
                    // Start default text if it was a silent attempt that failed
                    if (!silent) {
                        alert("Unable to retrieve your location");
                        resetBtn();
                    } else {
                        console.log("Auto-location unavailable or denied");
                    }
                }
            );

            function resetBtn() {
                if (!silent) {
                    btn.innerText = origText;
                    btn.disabled = false;
                }
            }
        }

        function manualLocate() {
            const input = document.getElementById('location');
            const query = input.value;
            if (!query) return;
            fetchWeather(`location=${encodeURIComponent(query)}`);
        }

        function fetchWeather(qs) {
            const display = document.getElementById('weather-display');
            display.style.opacity = '0.5';

            fetch(`/api/weather?${qs}`)
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(t || r.statusText) });
                    return r.text();
                })
                .then(html => {
                    display.innerHTML = html;
                    display.style.opacity = '1';

                    // Reset 'Locate Me' btn if it was used
                    const btn = document.getElementById('locate-btn');
                    if (btn.disabled) {
                        btn.innerText = "üìç Locate Me";
                        btn.disabled = false;
                    }
                })
                .catch(e => {
                    display.innerHTML = `<div style='text-align:center; padding: 2rem; color: #ef4444'>
                        <h3>Error</h3>
                        <p>${e.message.replace(/<[^>]*>?/gm, '')}</p>
                    </div>`;
                    display.style.opacity = '1';

                    const btn = document.getElementById('locate-btn');
                    if (btn.disabled) {
                        btn.innerText = "üìç Locate Me";
                        btn.disabled = false;
                    }
                });
        }
    </script>
</body>

</html>